<!DOCTYPE html>
<html>
<head>
  <title>Soccer Player Guessing Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }

    h1 {
      text-align: center;
    }

    #guess-form {
      text-align: center;
      margin-top: 20px;
    }

    #result {
      text-align: center;
      margin-top: 20px;
    }

    #player-image {
      max-width: 300px;
      margin: 20px auto;
      display: block;
    }

    #reveal-button {
      display: block;
      margin: 20px auto;
      text-align: center;
    }

    #clue-section {
      text-align: center;
      margin-top: 20px;
    }

    #clue-buttons {
      text-align: center;
      margin-top: 20px;
    }

    .clue-button {
      margin: 5px;
    }

    .clue-button.disabled {
      pointer-events: none;
      opacity: 0.5;
    }

    #clue-label {
      display: block;
      text-align: center;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>Guess the Footballer</h1>

  <div id="difficulty-section">
    <label for="difficulty">Difficulty:</label>
    <select id="difficulty" onchange="setDifficulty()">
      <option value="normal">Normal</option>
      <option value="hard">Hard</option>
      <option value="impossible">Impossible</option>
      <option value="random">Random</option>
    </select>
    <button onclick="startNewGame()">Change Difficulty</button> <!-- Moved Start Game button to the difficulty section -->
  </div>

  <div id="guess-form">
    <label for="guess">Guess:</label>
    <input type="text" id="guess" placeholder="Enter player name">
    <button onclick="checkGuess()">Submit</button>
  </div>

  <div id="result"></div>

  <p>Guesses Taken: <span id="guess-count">0</span></p>
  <p>Clues Used: <span id="clue-count">0</span></p>

  <div id="clue-section">
    <label id="clue-label" for="clue-buttons">Use a Clue:</label> <!-- Updated label for clue buttons -->
    <div id="clue-buttons">
      <button class="clue-button" onclick="provideClue('Club')">Club</button>
      <button class="clue-button" onclick="provideClue('Position')">Position</button>
      <button class="clue-button" onclick="provideClue('Birthday')">Birthday</button>
      <button class="clue-button" onclick="provideClue('Birthplace')">Birthplace</button>
      <button class="clue-button" onclick="provideClue('Peak Market Value')">Peak Market Value</button>
    </div>
  </div>

  <button id="reveal-button" onclick="revealPlayer()">Reveal Correct Player</button>
  <button onclick="startNewGame()">New Game</button> <!-- New Game button -->
  
  <script>
    var csvURL = 'tmarkt_players_05_09_2023.csv';
    var resultDiv = document.getElementById("result");
    var revealButton = document.getElementById("reveal-button");
    var clueButtons = document.getElementsByClassName("clue-button");
    var guessCountElement = document.getElementById("guess-count");
    var clueCountElement = document.getElementById("clue-count");
    var difficultySelect = document.getElementById("difficulty");

    var guessCount = 0; // Variable to track the number of guesses
    var clueCount = 0; // Variable to track the number of clues taken
    var takenClues = []; // Array to store the clues that have been taken

    fetch(csvURL)
      .then(response => response.text())
      .then(data => {
        var lines = data.trim().split('\n');
        var headers = lines[0].split(',');
        var players = [];

        for (var i = 1; i < lines.length; i++) {
          var currentLine = lines[i].split(',');
          var player = {};

          for (var j = 0; j < headers.length; j++) {
            player[headers[j]] = currentLine[j];
          }

          players.push(player);
        }

        // Call the function to start the game with the parsed player data
        startGame(players);
      })
      .catch(error => {
        console.error('Error fetching CSV data:', error);
      });

    var playerIndex;
    var player;
    var guessInput = document.getElementById("guess");
    var guessButton = document.querySelector("button");

    function startGame(players) {
      var difficulty = difficultySelect.value;

      var filteredPlayers;
      switch (difficulty) {
        case "normal":
          filteredPlayers = players.filter(player => player.highest_market_value_in_eur >= 50000000);
          break;
        case "hard":
          filteredPlayers = players.filter(player => player.highest_market_value_in_eur >= 10000000 && player.highest_market_value_in_eur <= 50000000);
          break;
        case "impossible":
          filteredPlayers = players.filter(player => player.highest_market_value_in_eur >= 1000000 && player.highest_market_value_in_eur <= 10000000);
          break;
        case "random":
          filteredPlayers = players.filter(player => player.highest_market_value_in_eur >= 10000000);
          break;
        default:
          filteredPlayers = players;
          break;
      }

      if (filteredPlayers.length === 0) {
        console.error('No players found for the selected difficulty');
        return;
      }

      playerIndex = Math.floor(Math.random() * filteredPlayers.length);
      player = filteredPlayers[playerIndex];
      guessInput.disabled = false;
      resultDiv.innerHTML = "";
      revealButton.style.display = "inline-block";
      for (var i = 0; i < clueButtons.length; i++) {
        clueButtons[i].style.display = "inline-block";
        clueButtons[i].classList.remove("disabled");
      }
      takenClues = [];
      guessCount = 0;
      clueCount = 0;
      guessCountElement.textContent = guessCount;
      clueCountElement.textContent = clueCount;
      document.getElementById("clue-section").style.display = "block"; // Show the clue section
      // Enable all clue buttons
      for (var i = 0; i < clueButtons.length; i++) {
        clueButtons[i].disabled = false;
      }
    }

    function checkGuess() {
      var guess = sanitizeInput(guessInput.value.trim());
      var playerName = sanitizeInput(player.name.toLowerCase());
      var playerLastName = sanitizeInput(player.last_name.toLowerCase());

      if (guess.toLowerCase() === playerName || guess.toLowerCase() === playerLastName) {
        var transfermarktURL = "https://www.transfermarkt.us/" + player.player_code + "/profil/spieler/" + player.player_id;
        resultDiv.innerHTML = "<p>Correct! The player is <a href='" + transfermarktURL + "' target='_blank'>" + player.name + "</a>.</p><img id='player-image' src='" + player.image_url + "' alt='Player Image'>";        
        guessInput.disabled = true;
        revealButton.style.display = "none";
        for (var i = 0; i < clueButtons.length; i++) {
          clueButtons[i].style.display = "none";
        }
        document.getElementById("clue-section").style.display = "none";
      } else {
        resultDiv.innerHTML = "<p>Incorrect. Keep guessing!</p>";
        displayTakenClues(); // Display all previously given clues
      }

      guessInput.value = "";
      guessCount++;
      guessCountElement.textContent = guessCount;
    }

    function displayTakenClues() {
      if (takenClues.length === 0) {
        resultDiv.innerHTML = "<p>Incorrect. Keep guessing!</p>";
        return; // Exit if no clues have been taken
      }

      var cluesHTML = "<p>Incorrect. Keep guessing!</p><p>Your clue(s):<br>";

      var uniqueClueTypes = [...new Set(takenClues)]; // Get unique clue types

      for (var i = 0; i < uniqueClueTypes.length; i++) {
        var clueType = uniqueClueTypes[i];
        var clue;

        switch (clueType) {
          case "Club":
            clue = player.current_club_name;
            break;
          case "Position":
            clue = player.position;
            break;
          case "Birthday":
            clue = player.date_of_birth;
            break;
          case "Birthplace":
            clue = player.city_of_birth.trim() + ", " + player.country_of_birth;
            break;
          case "Peak Market Value":
            clue = addCommasToNumber(player.highest_market_value_in_eur);
            break;
          default:
            clue = "No clue available";
            break;
        }

        cluesHTML += clueType + " - " + clue + "<br>";
      }

      cluesHTML += "</p>";
      resultDiv.innerHTML = cluesHTML; // Update the resultDiv content with the new clues
    }

    function addCommasToNumber(number) {
      return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function revealPlayer() {
      var transfermarktURL = "https://www.transfermarkt.us/" + player.player_code + "/profil/spieler/" + player.player_id;
      resultDiv.innerHTML = "<p>The correct player is <a href='" + transfermarktURL + "' target='_blank'>" + player.name + "</a>.</p><img id='player-image' src='" + player.image_url + "' alt='Player Image'>";
      revealButton.style.display = "none";
      for (var i = 0; i < clueButtons.length; i++) {
        clueButtons[i].style.display = "none";
      }
      document.getElementById("clue-section").style.display = "none";
    }


    function provideClue(clueType) {
      if (takenClues.includes(clueType)) {
        return; // Exit if the clue has already been taken
      }

      var clue;

      switch (clueType) {
        case "Club":
          clue = player.current_club_name;
          break;
        case "Position":
          clue = player.position;
          break;
        case "Birthday":
        var birthdayParts = player.date_of_birth.split("-");
        var month = getMonthName(birthdayParts[1]);
        var day = parseInt(birthdayParts[2], 10);
        var year = birthdayParts[0];
        clue = month + " " + day + ", " + year;
        break;
        case "Birthplace":
          clue = player.city_of_birth.trim() + ", " + player.country_of_birth;
          break;
        case "Peak Market Value":
          clue = "&euro;" + addCommasToNumber(player.highest_market_value_in_eur);
          if (clue.endsWith(".0")) {
            clue = clue.slice(0, -2); // Remove the decimal part if it's .0
          }
          break;
        default:
          clue = "No clue available";
          break;
      }

      resultDiv.innerHTML += "<p>New clue: " + clueType + " - " + clue + "</p>";
      clueCount++;
      clueCountElement.textContent = clueCount;
      takenClues.push(clueType);

      // Disable the selected clue button
      for (var i = 0; i < clueButtons.length; i++) {
        if (clueButtons[i].textContent === clueType) {
          clueButtons[i].classList.add("disabled");
          clueButtons[i].disabled = true;
          break;
        }
      }

      if (clueCount >= 5) {
        for (var i = 0; i < clueButtons.length; i++) {
          clueButtons[i].classList.add("disabled");
          clueButtons[i].disabled = true;
        }
      }
    }

    function startNewGame() {
      fetch(csvURL)
        .then(response => response.text())
        .then(data => {
          var lines = data.trim().split('\n');
          var headers = lines[0].split(',');
          var players = [];

          for (var i = 1; i < lines.length; i++) {
            var currentLine = lines[i].split(',');
            var player = {};

            for (var j = 0; j < headers.length; j++) {
              player[headers[j]] = currentLine[j];
            }

            players.push(player);
          }

          // Call the function to start a new game with the parsed player data
          startGame(players);
        })
        .catch(error => {
          console.error('Error fetching CSV data:', error);
        });
    }

    function sanitizeInput(input) {
      return input.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function getMonthName(monthNumber) {
      var months = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];

      return months[parseInt(monthNumber, 10) - 1];
    }
  </script>
</body>
</html>